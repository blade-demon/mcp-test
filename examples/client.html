<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MCP Server SSE Client</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .status {
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 20px;
      }
      .status.connected {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .status.disconnected {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .status.starting {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }
      .status.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .controls {
        margin-bottom: 20px;
      }
      button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 10px;
      }
      button:hover {
        background-color: #0056b3;
      }
      button:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
      }
      .tool-section {
        margin-bottom: 30px;
        padding: 15px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
      }
      .tool-section h3 {
        margin-top: 0;
        color: #495057;
      }
      input,
      select {
        padding: 8px;
        margin: 5px;
        border: 1px solid #ced4da;
        border-radius: 4px;
      }
      .response {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 10px;
        margin-top: 10px;
        white-space: pre-wrap;
        font-family: monospace;
        max-height: 200px;
        overflow-y: auto;
      }
      .log {
        background-color: #343a40;
        color: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        margin-top: 20px;
        max-height: 300px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 12px;
      }
      .log-entry {
        margin-bottom: 4px;
        padding: 2px 0;
        border-bottom: 1px solid #495057;
        word-wrap: break-word;
      }
      .log-entry:last-child {
        border-bottom: none;
      }
      .log-info {
        color: #17a2b8;
      }
      .log-success {
        color: #28a745;
      }
      .log-error {
        color: #dc3545;
      }
      .log-warning {
        color: #ffc107;
      }
      .log-send {
        color: #6f42c1;
      }
      .log-receive {
        color: #20c997;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸš€ MCP Server SSE Client</h1>

      <div id="status" class="status disconnected">æœªè¿æ¥</div>

      <div class="controls">
        <button id="connectBtn" onclick="connect()">è¿æ¥</button>
        <button id="disconnectBtn" onclick="disconnect()" disabled>
          æ–­å¼€è¿æ¥
        </button>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
      </div>

      <!-- è®¡ç®—å™¨å·¥å…· -->
      <div class="tool-section">
        <h3>ğŸ§® è®¡ç®—å™¨å·¥å…·</h3>
        <select id="calcOperation">
          <option value="add">åŠ æ³• (+)</option>
          <option value="subtract">å‡æ³• (-)</option>
          <option value="multiply">ä¹˜æ³• (Ã—)</option>
          <option value="divide">é™¤æ³• (Ã·)</option>
        </select>
        <input type="number" id="calcA" placeholder="æ•°å­—A" value="10" />
        <input type="number" id="calcB" placeholder="æ•°å­—B" value="5" />
        <button onclick="callCalculator()">è®¡ç®—</button>
        <div id="calcResponse" class="response" style="display: none"></div>
      </div>

      <!-- å­¦ç”Ÿæˆç»©æŸ¥è¯¢å·¥å…· -->
      <div class="tool-section">
        <h3>ğŸ“Š å­¦ç”Ÿæˆç»©æŸ¥è¯¢å·¥å…·</h3>
        <select id="gradeQueryType">
          <option value="total_highest">æ€»åˆ†æœ€é«˜</option>
          <option value="chinese_highest">è¯­æ–‡æœ€é«˜</option>
          <option value="math_highest">æ•°å­¦æœ€é«˜</option>
          <option value="english_highest">è‹±è¯­æœ€é«˜</option>
          <option value="all_highest">æ‰€æœ‰æœ€é«˜åˆ†</option>
        </select>
        <button onclick="callStudentGrades()">æŸ¥è¯¢</button>
        <div id="gradeResponse" class="response" style="display: none"></div>
      </div>

      <!-- ç¬‘è¯å·¥å…· -->
      <div class="tool-section">
        <h3>ğŸ˜„ ç¬‘è¯å·¥å…·</h3>
        <input
          type="text"
          id="jokeTopic"
          placeholder="ç¬‘è¯ä¸»é¢˜"
          value="programming"
        />
        <button onclick="callJoker()">è·å–ç¬‘è¯</button>
        <div id="jokeResponse" class="response" style="display: none"></div>
      </div>

      <!-- é—®å€™èµ„æº -->
      <div class="tool-section">
        <h3>ğŸ‘‹ é—®å€™èµ„æº</h3>
        <input
          type="text"
          id="greetingName"
          placeholder="å§“å"
          value="å¾ç´«å¾®"
        />
        <button onclick="callGreeting()">ç”Ÿæˆé—®å€™</button>
        <div id="greetingResponse" class="response" style="display: none"></div>
      </div>

      <!-- LLM å¤§æ¨¡å‹è°ƒç”¨å·¥å…· -->
      <div class="tool-section">
        <h3>ğŸ¤– LLM å¤§æ¨¡å‹è°ƒç”¨</h3>
        <div style="margin-bottom: 10px">
          <label>è¯·æ±‚ç±»å‹ï¼š</label>
          <select id="llmType">
            <option value="chat">å¯¹è¯</option>
            <option value="generate">æ–‡æœ¬ç”Ÿæˆ</option>
            <option value="translate">ç¿»è¯‘</option>
            <option value="summary">æ‘˜è¦</option>
            <option value="code">ä»£ç ç”Ÿæˆ</option>
            <option value="vision">å›¾åƒç†è§£</option>
          </select>
        </div>

        <div style="margin-bottom: 10px">
          <label>æ¨¡å‹ï¼š</label>
          <select id="llmModel">
            <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
          </select>
        </div>

        <div style="margin-bottom: 10px">
          <label>ç¼–ç¨‹è¯­è¨€ï¼š</label>
          <input
            type="text"
            id="llmLanguage"
            placeholder="ç¼–ç¨‹è¯­è¨€ï¼ˆä»£ç ç”Ÿæˆæ—¶ä½¿ç”¨ï¼‰"
            value="javascript"
          />
        </div>

        <div style="margin-bottom: 10px">
          <label>æ¸©åº¦ï¼š</label>
          <input
            type="range"
            id="llmTemperature"
            min="0"
            max="2"
            step="0.1"
            value="0.7"
          />
          <span id="temperatureValue">0.7</span>
        </div>

        <div style="margin-bottom: 10px">
          <label>æœ€å¤§Tokenæ•°ï¼š</label>
          <input
            type="number"
            id="llmMaxTokens"
            placeholder="æœ€å¤§ç”Ÿæˆtokenæ•°"
            value="2000"
          />
        </div>

        <div style="margin-bottom: 10px">
          <label>æµå¼å“åº”ï¼š</label>
          <input type="checkbox" id="llmStream" />
        </div>

        <div style="margin-bottom: 10px">
          <label>å¯¹è¯IDï¼š</label>
          <input
            type="text"
            id="llmConversationId"
            placeholder="å¤šè½®å¯¹è¯IDï¼ˆå¯é€‰ï¼‰"
          />
        </div>

        <div style="margin-bottom: 10px">
          <label>å›¾ç‰‡URLï¼š</label>
          <input
            type="text"
            id="llmImages"
            placeholder="å›¾ç‰‡URLï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”"
          />
        </div>

        <textarea
          id="llmPrompt"
          placeholder="è¾“å…¥æ‚¨çš„æç¤ºè¯..."
          rows="4"
          style="width: 100%; margin-bottom: 10px"
        >
ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±</textarea
        >
        <br />
        <button onclick="callLLM()">å‘é€è¯·æ±‚</button>
        <button onclick="checkLLMStatus()">æ£€æŸ¥çŠ¶æ€</button>
        <button onclick="getPerformanceStats()">æ€§èƒ½ç»Ÿè®¡</button>
        <button onclick="getPromptTemplates()">è·å–æ¨¡æ¿</button>
        <div id="llmResponse" class="response" style="display: none"></div>
      </div>

      <!-- æ—¥å¿— -->
      <div class="log" id="log"></div>
    </div>

    <script>
      let eventSource = null;
      let sessionId = null;

      function log(message, type = "info") {
        const logElement = document.getElementById("log");
        const timestamp = new Date().toLocaleTimeString();
        const typeIcon = {
          info: "â„¹ï¸",
          success: "âœ…",
          error: "âŒ",
          warning: "âš ï¸",
          send: "ğŸ“¤",
          receive: "ğŸ“¨",
        };

        const icon = typeIcon[type] || "â„¹ï¸";
        logElement.innerHTML += `<div class="log-entry log-${type}">[${timestamp}] ${icon} ${message}</div>`;
        logElement.scrollTop = logElement.scrollHeight;
      }

      function updateStatus(status, message = "") {
        const statusElement = document.getElementById("status");
        const connectBtn = document.getElementById("connectBtn");
        const disconnectBtn = document.getElementById("disconnectBtn");

        switch (status) {
          case "starting":
            statusElement.className = "status starting";
            statusElement.textContent = `å¯åŠ¨ä¸­... ${message}`;
            connectBtn.disabled = true;
            disconnectBtn.disabled = true;
            break;
          case "connected":
            statusElement.className = "status connected";
            statusElement.textContent = `å·²è¿æ¥ (Session: ${sessionId})`;
            connectBtn.disabled = true;
            disconnectBtn.disabled = false;
            break;
          case "error":
            statusElement.className = "status error";
            statusElement.textContent = `è¿æ¥é”™è¯¯: ${message}`;
            connectBtn.disabled = false;
            disconnectBtn.disabled = true;
            break;
          case "disconnected":
          default:
            statusElement.className = "status disconnected";
            statusElement.textContent = "æœªè¿æ¥";
            connectBtn.disabled = false;
            disconnectBtn.disabled = true;
            break;
        }
      }

      function connect() {
        sessionId = `client_${Date.now()}`;
        const url = `http://localhost:3000/sse?sessionId=${sessionId}`;

        log(`æ­£åœ¨è¿æ¥åˆ°: ${url}`);

        eventSource = new EventSource(url);

        eventSource.onopen = function () {
          log("SSEè¿æ¥å·²å»ºç«‹");
        };

        eventSource.addEventListener("connected", function (event) {
          const data = JSON.parse(event.data);
          log(`æœåŠ¡å™¨æ¶ˆæ¯: ${data.message}`, "success");
          updateStatus("connected");
        });

        eventSource.addEventListener("server-status", function (event) {
          const data = JSON.parse(event.data);
          log(`æœåŠ¡å™¨çŠ¶æ€: ${data.status} - ${data.message}`);

          switch (data.status) {
            case "starting":
              updateStatus("starting", data.message);
              break;
            case "started":
              updateStatus("connected");
              if (data.serverInfo) {
                log(`æœåŠ¡å™¨ä¿¡æ¯: ${JSON.stringify(data.serverInfo, null, 2)}`);
              }
              break;
            case "error":
              updateStatus("error", data.message);
              break;
          }
        });

        eventSource.addEventListener("mcp-message", function (event) {
          const message = JSON.parse(event.data);

          // æ ¼å¼åŒ– MCP æ¶ˆæ¯æ˜¾ç¤º
          let logMessage = "";
          if (message.result && message.result.content) {
            const content = message.result.content[0];
            if (content.type === "text") {
              logMessage = `æ”¶åˆ°å“åº”: ${content.text.substring(0, 100)}${
                content.text.length > 100 ? "..." : ""
              }`;
            }
          } else if (message.error) {
            logMessage = `é”™è¯¯: ${message.error.message || "æœªçŸ¥é”™è¯¯"}`;
          } else {
            logMessage = `æ”¶åˆ°MCPæ¶ˆæ¯: ${message.method || "æœªçŸ¥æ–¹æ³•"}`;
          }

          log(logMessage, "receive");

          // å¤„ç†å“åº”æ¶ˆæ¯
          if (message.content) {
            handleMcpResponse(message);
          }
        });

        eventSource.addEventListener("disconnected", function (event) {
          const data = JSON.parse(event.data);
          log(`æœåŠ¡å™¨æ–­å¼€: ${data.message}`, "warning");
          updateStatus("disconnected");
        });

        eventSource.onerror = function (error) {
          log(`SSEé”™è¯¯: ${error}`, "error");
          updateStatus("error", "è¿æ¥é”™è¯¯");
        };
      }

      function disconnect() {
        if (eventSource) {
          eventSource.close();
          eventSource = null;
          log("å·²æ–­å¼€è¿æ¥", "info");
          updateStatus("disconnected");
        }
      }

      function clearLog() {
        document.getElementById("log").innerHTML = "";
      }

      async function sendMcpMessage(message) {
        if (!sessionId) {
          log("é”™è¯¯: æœªè¿æ¥åˆ°æœåŠ¡å™¨", "error");
          return;
        }

        try {
          const response = await fetch(
            `http://localhost:3000/mcp/${sessionId}`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(message),
            }
          );

          if (response.ok) {
            const toolName = message.params?.name || "æœªçŸ¥å·¥å…·";
            log(`å·²å‘é€è¯·æ±‚: ${toolName}`, "send");
          } else {
            log(`å‘é€å¤±è´¥: ${response.statusText}`, "error");
          }
        } catch (error) {
          log(`å‘é€é”™è¯¯: ${error.message}`, "error");
        }
      }

      function handleMcpResponse(message) {
        if (message.content && message.content.length > 0) {
          const content = message.content[0];
          if (content.type === "text") {
            // æ ¹æ®å·¥å…·ç±»å‹æ˜¾ç¤ºå“åº”
            if (message.tool_calls) {
              const toolCall = message.tool_calls[0];
              const toolName = toolCall.function.name;

              switch (toolName) {
                case "calculator":
                  document.getElementById("calcResponse").textContent =
                    content.text;
                  document.getElementById("calcResponse").style.display =
                    "block";
                  break;
                case "student_grades":
                  document.getElementById("gradeResponse").textContent =
                    content.text;
                  document.getElementById("gradeResponse").style.display =
                    "block";
                  break;
                case "joker":
                  document.getElementById("jokeResponse").textContent =
                    content.text;
                  document.getElementById("jokeResponse").style.display =
                    "block";
                  break;
                case "llm":
                  document.getElementById("llmResponse").textContent =
                    content.text;
                  document.getElementById("llmResponse").style.display =
                    "block";
                  break;
              }
            }
          }
        }
      }

      function callCalculator() {
        const operation = document.getElementById("calcOperation").value;
        const a = parseFloat(document.getElementById("calcA").value);
        const b = parseFloat(document.getElementById("calcB").value);

        const message = {
          jsonrpc: "2.0",
          id: Date.now(),
          method: "tools/call",
          params: {
            name: "calculator",
            arguments: {
              operation: operation,
              a: a,
              b: b,
            },
          },
        };

        sendMcpMessage(message);
      }

      function callStudentGrades() {
        const queryType = document.getElementById("gradeQueryType").value;

        const message = {
          jsonrpc: "2.0",
          id: Date.now(),
          method: "tools/call",
          params: {
            name: "student_grades",
            arguments: {
              query_type: queryType,
            },
          },
        };

        sendMcpMessage(message);
      }

      function callJoker() {
        const topic = document.getElementById("jokeTopic").value;

        const message = {
          jsonrpc: "2.0",
          id: Date.now(),
          method: "tools/call",
          params: {
            name: "joker",
            arguments: {
              topic: topic,
            },
          },
        };

        sendMcpMessage(message);
      }

      function callGreeting() {
        const name = document.getElementById("greetingName").value;

        const message = {
          jsonrpc: "2.0",
          id: Date.now(),
          method: "resources/read",
          params: {
            uri: `greeting://${name}`,
          },
        };

        sendMcpMessage(message);
      }

      function callLLM() {
        const type = document.getElementById("llmType").value;
        const prompt = document.getElementById("llmPrompt").value;
        const model = document.getElementById("llmModel").value;
        const language = document.getElementById("llmLanguage").value;
        const temperature = parseFloat(
          document.getElementById("llmTemperature").value
        );
        const maxTokens = parseInt(
          document.getElementById("llmMaxTokens").value
        );
        const stream = document.getElementById("llmStream").checked;
        const conversationId =
          document.getElementById("llmConversationId").value;
        const imagesInput = document.getElementById("llmImages").value;

        if (!prompt.trim()) {
          log("âŒ è¯·è¾“å…¥æç¤ºè¯", "error");
          return;
        }

        // å¤„ç†å›¾ç‰‡URL
        const images = imagesInput
          ? imagesInput
              .split(",")
              .map((url) => url.trim())
              .filter((url) => url)
          : undefined;

        const message = {
          jsonrpc: "2.0",
          id: Date.now(),
          method: "tools/call",
          params: {
            name: "llm",
            arguments: {
              type: type,
              prompt: prompt,
              model: model,
              language: language || undefined,
              temperature: temperature,
              max_tokens: maxTokens,
              stream: stream,
              conversation_id: conversationId || undefined,
              images: images,
            },
          },
        };

        sendMcpMessage(message);
      }

      function checkLLMStatus() {
        const message = {
          jsonrpc: "2.0",
          id: Date.now(),
          method: "tools/call",
          params: {
            name: "llm",
            arguments: {
              type: "chat",
              prompt: "è¯·æ£€æŸ¥LLMæœåŠ¡çŠ¶æ€",
            },
          },
        };

        sendMcpMessage(message);
      }

      function getPerformanceStats() {
        const message = {
          jsonrpc: "2.0",
          id: Date.now(),
          method: "tools/call",
          params: {
            name: "llm",
            arguments: {
              type: "chat",
              prompt: "è·å–æ€§èƒ½ç»Ÿè®¡ä¿¡æ¯",
            },
          },
        };

        sendMcpMessage(message);
      }

      function getPromptTemplates() {
        const message = {
          jsonrpc: "2.0",
          id: Date.now(),
          method: "tools/call",
          params: {
            name: "llm",
            arguments: {
              type: "chat",
              prompt: "è·å–æç¤ºè¯æ¨¡æ¿åˆ—è¡¨",
            },
          },
        };

        sendMcpMessage(message);
      }

      // æ¸©åº¦æ»‘å—å®æ—¶æ›´æ–°
      document
        .getElementById("llmTemperature")
        .addEventListener("input", function () {
          document.getElementById("temperatureValue").textContent = this.value;
        });

      // åªæ”¯æŒ Gemini 2.0 Proï¼Œæ— éœ€åŠ¨æ€æ›´æ–°æ¨¡å‹é€‰é¡¹

      // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿æ¥
      window.onload = function () {
        log("é¡µé¢å·²åŠ è½½ï¼Œç‚¹å‡»è¿æ¥æŒ‰é’®å¼€å§‹", "info");
      };
    </script>
  </body>
</html>
