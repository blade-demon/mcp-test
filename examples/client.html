<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MCP Server SSE Client</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .status {
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 20px;
      }
      .status.connected {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .status.disconnected {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .status.starting {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }
      .status.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .controls {
        margin-bottom: 20px;
      }
      button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 10px;
      }
      button:hover {
        background-color: #0056b3;
      }
      button:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
      }
      .tool-section {
        margin-bottom: 30px;
        padding: 15px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
      }
      .tool-section h3 {
        margin-top: 0;
        color: #495057;
      }
      input,
      select {
        padding: 8px;
        margin: 5px;
        border: 1px solid #ced4da;
        border-radius: 4px;
      }
      .response {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 10px;
        margin-top: 10px;
        white-space: pre-wrap;
        font-family: monospace;
        max-height: 200px;
        overflow-y: auto;
      }
      .log {
        background-color: #343a40;
        color: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        margin-top: 20px;
        max-height: 300px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 12px;
      }
      .log-entry {
        margin-bottom: 4px;
        padding: 2px 0;
        border-bottom: 1px solid #495057;
        word-wrap: break-word;
      }
      .log-entry:last-child {
        border-bottom: none;
      }
      .log-info {
        color: #17a2b8;
      }
      .log-success {
        color: #28a745;
      }
      .log-error {
        color: #dc3545;
      }
      .log-warning {
        color: #ffc107;
      }
      .log-send {
        color: #6f42c1;
      }
      .log-receive {
        color: #20c997;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>🚀 MCP Server SSE Client</h1>

      <div id="status" class="status disconnected">未连接</div>

      <div class="controls">
        <button id="connectBtn" onclick="connect()">连接</button>
        <button id="disconnectBtn" onclick="disconnect()" disabled>
          断开连接
        </button>
        <button onclick="clearLog()">清空日志</button>
      </div>

      <!-- 计算器工具 -->
      <div class="tool-section">
        <h3>🧮 计算器工具</h3>
        <select id="calcOperation">
          <option value="add">加法 (+)</option>
          <option value="subtract">减法 (-)</option>
          <option value="multiply">乘法 (×)</option>
          <option value="divide">除法 (÷)</option>
        </select>
        <input type="number" id="calcA" placeholder="数字A" value="10" />
        <input type="number" id="calcB" placeholder="数字B" value="5" />
        <button onclick="callCalculator()">计算</button>
        <div id="calcResponse" class="response" style="display: none"></div>
      </div>

      <!-- 学生成绩查询工具 -->
      <div class="tool-section">
        <h3>📊 学生成绩查询工具</h3>
        <select id="gradeQueryType">
          <option value="total_highest">总分最高</option>
          <option value="chinese_highest">语文最高</option>
          <option value="math_highest">数学最高</option>
          <option value="english_highest">英语最高</option>
          <option value="all_highest">所有最高分</option>
        </select>
        <button onclick="callStudentGrades()">查询</button>
        <div id="gradeResponse" class="response" style="display: none"></div>
      </div>

      <!-- 笑话工具 -->
      <div class="tool-section">
        <h3>😄 笑话工具</h3>
        <input
          type="text"
          id="jokeTopic"
          placeholder="笑话主题"
          value="programming"
        />
        <button onclick="callJoker()">获取笑话</button>
        <div id="jokeResponse" class="response" style="display: none"></div>
      </div>

      <!-- 问候资源 -->
      <div class="tool-section">
        <h3>👋 问候资源</h3>
        <input
          type="text"
          id="greetingName"
          placeholder="姓名"
          value="徐紫微"
        />
        <button onclick="callGreeting()">生成问候</button>
        <div id="greetingResponse" class="response" style="display: none"></div>
      </div>

      <!-- LLM 大模型调用工具 -->
      <div class="tool-section">
        <h3>🤖 LLM 大模型调用</h3>
        <div style="margin-bottom: 10px">
          <label>请求类型：</label>
          <select id="llmType">
            <option value="chat">对话</option>
            <option value="generate">文本生成</option>
            <option value="translate">翻译</option>
            <option value="summary">摘要</option>
            <option value="code">代码生成</option>
            <option value="vision">图像理解</option>
          </select>
        </div>

        <div style="margin-bottom: 10px">
          <label>模型：</label>
          <select id="llmModel">
            <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
          </select>
        </div>

        <div style="margin-bottom: 10px">
          <label>编程语言：</label>
          <input
            type="text"
            id="llmLanguage"
            placeholder="编程语言（代码生成时使用）"
            value="javascript"
          />
        </div>

        <div style="margin-bottom: 10px">
          <label>温度：</label>
          <input
            type="range"
            id="llmTemperature"
            min="0"
            max="2"
            step="0.1"
            value="0.7"
          />
          <span id="temperatureValue">0.7</span>
        </div>

        <div style="margin-bottom: 10px">
          <label>最大Token数：</label>
          <input
            type="number"
            id="llmMaxTokens"
            placeholder="最大生成token数"
            value="2000"
          />
        </div>

        <div style="margin-bottom: 10px">
          <label>流式响应：</label>
          <input type="checkbox" id="llmStream" />
        </div>

        <div style="margin-bottom: 10px">
          <label>对话ID：</label>
          <input
            type="text"
            id="llmConversationId"
            placeholder="多轮对话ID（可选）"
          />
        </div>

        <div style="margin-bottom: 10px">
          <label>图片URL：</label>
          <input
            type="text"
            id="llmImages"
            placeholder="图片URL，多个用逗号分隔"
          />
        </div>

        <textarea
          id="llmPrompt"
          placeholder="输入您的提示词..."
          rows="4"
          style="width: 100%; margin-bottom: 10px"
        >
你好，请介绍一下你自己</textarea
        >
        <br />
        <button onclick="callLLM()">发送请求</button>
        <button onclick="checkLLMStatus()">检查状态</button>
        <button onclick="getPerformanceStats()">性能统计</button>
        <button onclick="getPromptTemplates()">获取模板</button>
        <div id="llmResponse" class="response" style="display: none"></div>
      </div>

      <!-- 日志 -->
      <div class="log" id="log"></div>
    </div>

    <script>
      let eventSource = null;
      let sessionId = null;

      function log(message, type = "info") {
        const logElement = document.getElementById("log");
        const timestamp = new Date().toLocaleTimeString();
        const typeIcon = {
          info: "ℹ️",
          success: "✅",
          error: "❌",
          warning: "⚠️",
          send: "📤",
          receive: "📨",
        };

        const icon = typeIcon[type] || "ℹ️";
        logElement.innerHTML += `<div class="log-entry log-${type}">[${timestamp}] ${icon} ${message}</div>`;
        logElement.scrollTop = logElement.scrollHeight;
      }

      function updateStatus(status, message = "") {
        const statusElement = document.getElementById("status");
        const connectBtn = document.getElementById("connectBtn");
        const disconnectBtn = document.getElementById("disconnectBtn");

        switch (status) {
          case "starting":
            statusElement.className = "status starting";
            statusElement.textContent = `启动中... ${message}`;
            connectBtn.disabled = true;
            disconnectBtn.disabled = true;
            break;
          case "connected":
            statusElement.className = "status connected";
            statusElement.textContent = `已连接 (Session: ${sessionId})`;
            connectBtn.disabled = true;
            disconnectBtn.disabled = false;
            break;
          case "error":
            statusElement.className = "status error";
            statusElement.textContent = `连接错误: ${message}`;
            connectBtn.disabled = false;
            disconnectBtn.disabled = true;
            break;
          case "disconnected":
          default:
            statusElement.className = "status disconnected";
            statusElement.textContent = "未连接";
            connectBtn.disabled = false;
            disconnectBtn.disabled = true;
            break;
        }
      }

      function connect() {
        sessionId = `client_${Date.now()}`;
        const url = `http://localhost:3000/sse?sessionId=${sessionId}`;

        log(`正在连接到: ${url}`);

        eventSource = new EventSource(url);

        eventSource.onopen = function () {
          log("SSE连接已建立");
        };

        eventSource.addEventListener("connected", function (event) {
          const data = JSON.parse(event.data);
          log(`服务器消息: ${data.message}`, "success");
          updateStatus("connected");
        });

        eventSource.addEventListener("server-status", function (event) {
          const data = JSON.parse(event.data);
          log(`服务器状态: ${data.status} - ${data.message}`);

          switch (data.status) {
            case "starting":
              updateStatus("starting", data.message);
              break;
            case "started":
              updateStatus("connected");
              if (data.serverInfo) {
                log(`服务器信息: ${JSON.stringify(data.serverInfo, null, 2)}`);
              }
              break;
            case "error":
              updateStatus("error", data.message);
              break;
          }
        });

        eventSource.addEventListener("mcp-message", function (event) {
          const message = JSON.parse(event.data);

          // 格式化 MCP 消息显示
          let logMessage = "";
          if (message.result && message.result.content) {
            const content = message.result.content[0];
            if (content.type === "text") {
              logMessage = `收到响应: ${content.text.substring(0, 100)}${
                content.text.length > 100 ? "..." : ""
              }`;
            }
          } else if (message.error) {
            logMessage = `错误: ${message.error.message || "未知错误"}`;
          } else {
            logMessage = `收到MCP消息: ${message.method || "未知方法"}`;
          }

          log(logMessage, "receive");

          // 处理响应消息
          if (message.content) {
            handleMcpResponse(message);
          }
        });

        eventSource.addEventListener("disconnected", function (event) {
          const data = JSON.parse(event.data);
          log(`服务器断开: ${data.message}`, "warning");
          updateStatus("disconnected");
        });

        eventSource.onerror = function (error) {
          log(`SSE错误: ${error}`, "error");
          updateStatus("error", "连接错误");
        };
      }

      function disconnect() {
        if (eventSource) {
          eventSource.close();
          eventSource = null;
          log("已断开连接", "info");
          updateStatus("disconnected");
        }
      }

      function clearLog() {
        document.getElementById("log").innerHTML = "";
      }

      async function sendMcpMessage(message) {
        if (!sessionId) {
          log("错误: 未连接到服务器", "error");
          return;
        }

        try {
          const response = await fetch(
            `http://localhost:3000/mcp/${sessionId}`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(message),
            }
          );

          if (response.ok) {
            const toolName = message.params?.name || "未知工具";
            log(`已发送请求: ${toolName}`, "send");
          } else {
            log(`发送失败: ${response.statusText}`, "error");
          }
        } catch (error) {
          log(`发送错误: ${error.message}`, "error");
        }
      }

      function handleMcpResponse(message) {
        if (message.content && message.content.length > 0) {
          const content = message.content[0];
          if (content.type === "text") {
            // 根据工具类型显示响应
            if (message.tool_calls) {
              const toolCall = message.tool_calls[0];
              const toolName = toolCall.function.name;

              switch (toolName) {
                case "calculator":
                  document.getElementById("calcResponse").textContent =
                    content.text;
                  document.getElementById("calcResponse").style.display =
                    "block";
                  break;
                case "student_grades":
                  document.getElementById("gradeResponse").textContent =
                    content.text;
                  document.getElementById("gradeResponse").style.display =
                    "block";
                  break;
                case "joker":
                  document.getElementById("jokeResponse").textContent =
                    content.text;
                  document.getElementById("jokeResponse").style.display =
                    "block";
                  break;
                case "llm":
                  document.getElementById("llmResponse").textContent =
                    content.text;
                  document.getElementById("llmResponse").style.display =
                    "block";
                  break;
              }
            }
          }
        }
      }

      function callCalculator() {
        const operation = document.getElementById("calcOperation").value;
        const a = parseFloat(document.getElementById("calcA").value);
        const b = parseFloat(document.getElementById("calcB").value);

        const message = {
          jsonrpc: "2.0",
          id: Date.now(),
          method: "tools/call",
          params: {
            name: "calculator",
            arguments: {
              operation: operation,
              a: a,
              b: b,
            },
          },
        };

        sendMcpMessage(message);
      }

      function callStudentGrades() {
        const queryType = document.getElementById("gradeQueryType").value;

        const message = {
          jsonrpc: "2.0",
          id: Date.now(),
          method: "tools/call",
          params: {
            name: "student_grades",
            arguments: {
              query_type: queryType,
            },
          },
        };

        sendMcpMessage(message);
      }

      function callJoker() {
        const topic = document.getElementById("jokeTopic").value;

        const message = {
          jsonrpc: "2.0",
          id: Date.now(),
          method: "tools/call",
          params: {
            name: "joker",
            arguments: {
              topic: topic,
            },
          },
        };

        sendMcpMessage(message);
      }

      function callGreeting() {
        const name = document.getElementById("greetingName").value;

        const message = {
          jsonrpc: "2.0",
          id: Date.now(),
          method: "resources/read",
          params: {
            uri: `greeting://${name}`,
          },
        };

        sendMcpMessage(message);
      }

      function callLLM() {
        const type = document.getElementById("llmType").value;
        const prompt = document.getElementById("llmPrompt").value;
        const model = document.getElementById("llmModel").value;
        const language = document.getElementById("llmLanguage").value;
        const temperature = parseFloat(
          document.getElementById("llmTemperature").value
        );
        const maxTokens = parseInt(
          document.getElementById("llmMaxTokens").value
        );
        const stream = document.getElementById("llmStream").checked;
        const conversationId =
          document.getElementById("llmConversationId").value;
        const imagesInput = document.getElementById("llmImages").value;

        if (!prompt.trim()) {
          log("❌ 请输入提示词", "error");
          return;
        }

        // 处理图片URL
        const images = imagesInput
          ? imagesInput
              .split(",")
              .map((url) => url.trim())
              .filter((url) => url)
          : undefined;

        const message = {
          jsonrpc: "2.0",
          id: Date.now(),
          method: "tools/call",
          params: {
            name: "llm",
            arguments: {
              type: type,
              prompt: prompt,
              model: model,
              language: language || undefined,
              temperature: temperature,
              max_tokens: maxTokens,
              stream: stream,
              conversation_id: conversationId || undefined,
              images: images,
            },
          },
        };

        sendMcpMessage(message);
      }

      function checkLLMStatus() {
        const message = {
          jsonrpc: "2.0",
          id: Date.now(),
          method: "tools/call",
          params: {
            name: "llm",
            arguments: {
              type: "chat",
              prompt: "请检查LLM服务状态",
            },
          },
        };

        sendMcpMessage(message);
      }

      function getPerformanceStats() {
        const message = {
          jsonrpc: "2.0",
          id: Date.now(),
          method: "tools/call",
          params: {
            name: "llm",
            arguments: {
              type: "chat",
              prompt: "获取性能统计信息",
            },
          },
        };

        sendMcpMessage(message);
      }

      function getPromptTemplates() {
        const message = {
          jsonrpc: "2.0",
          id: Date.now(),
          method: "tools/call",
          params: {
            name: "llm",
            arguments: {
              type: "chat",
              prompt: "获取提示词模板列表",
            },
          },
        };

        sendMcpMessage(message);
      }

      // 温度滑块实时更新
      document
        .getElementById("llmTemperature")
        .addEventListener("input", function () {
          document.getElementById("temperatureValue").textContent = this.value;
        });

      // 只支持 Gemini 2.0 Pro，无需动态更新模型选项

      // 页面加载时自动连接
      window.onload = function () {
        log("页面已加载，点击连接按钮开始", "info");
      };
    </script>
  </body>
</html>
